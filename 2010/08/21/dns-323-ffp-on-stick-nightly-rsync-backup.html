<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="chrome=1">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<link rel=stylesheet href=/blog.css>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<title>
DNS-323: FFP on a stick, nightly rsync backup... &ndash; ebullient·works
</title>
<link rel=canonical href=/2010/08/21/dns-323-ffp-on-stick-nightly-rsync-backup.html>
</head>
<body>
<div class=wrapper>
<header class=page-header>
<h1><a href=/>ebullient·works</a></h1>
<div>
[ <a href=/about/>About</a> &#183; <a href=/archive/>Archive</a> &#183; <a href=/tags/>Tags</a> ]
</div>
</header>
<main class=page id=content>
<article class=post>
<header>
<h1>DNS-323: FFP on a stick, nightly rsync backup... </h1>
</header>
<section class=content>
<p>I have a lot of things working well, gathered from a lot of resources. I tweaked some scripts to make them work better:</p>
<ul>
<li>I created an /ffp/<hostname> directory for my personal scripts.</li>
<li>I have an rsync script that mirrors the ffp installation on the USB stick (/mnt/usb/ffp) to the primary hard drive (/mnt/HD_a2). This means I only have to maintain the USB-copy, but if the USB is not available, I'll still have working stuff on the regular drive.</li>
<li>I have a few (small) scripts that I use for cron jobs, rather than putting it all directly into the cron task: has the advantage of being able to use logger to add syslog messages.</li>
</ul>
<p>Very very simple: ffp-sync.sh for keeping the usb ffp in sync with the copy on the hard drive. I have this as a small, separate, invokable script so that I can run the backup myself if I've made changes and am feeling paranoid/proactive.</p>
<div class=code>#!/ffp/bin/sh
rsync -av --exclude=packages \
--exclude=var/log \
--exclude=var/run \
--delete /mnt/usb/ffp/ /mnt/HD_a2/ffp
</div>
<p>This is the rsync line for the nightly backup from HD_a2 to HD_b2, based on scripts from the forum post(s) and the interwebs (see references below). The only real change here: using logger to get some evidence in the syslog about when backups start/stop.</p>
<div class=code>#!/ffp/bin/sh
export PATH=/ffp/sbin:/ffp/bin:$PATH
mv /ffp/var/log/rsync.last.log /ffp/var/log/rsync.last.log.prev
srcpath=/mnt/HD_a2/
dstpath=/mnt/HD_b2/backup
date=`date "+%Y%m%d"`
mkdir $dstpath/$date
logger Begin backup: $date
# Use rsync to backup content from the $srcpath to $dstpath/$date
# The contents of --link-dest=$dstpath/current are used as a 'base':
# files are hard-linked from that directory unless they've been changed,
# in which case the file is copied $srcpath.
# -ii is used to include detail in the log (which files are linked, which are copied)
/ffp/bin/rsync -avx -ii \
--exclude=ffp/var/log \
--exclude=ffp/var/run \
--exclude=lost+found \
--link-dest=$dstpath/current $srcpath $dstpath/$date \
> /ffp/var/log/rsync.last.log 2>&1

var=`ls -1A $dstpath/$date | wc -l`
echo $var
if [ $var -ne 0 ]
then
rm $dstpath/current
ln -s $date $dstpath/current
fi
logger Backup complete: $date
</div>
<p>
I also made a script (w/ syslog message: I like to be able to look back when things go wrong and know if/when cron jobs were running): </p>
<div class=code>#!/ffp/bin/sh
logger Checking time via sntp
/usr/sbin/sntp -r -P no us.pool.ntp.org
</div>
<p>
All of this is set up with /ffp/etc/fun_plug.local (of course). Having the home directories on the USB stick avoids the issues I was having before with the permissions being reset. I've preserved the authorized scripts, though, and ensure that they're run if/when the usb stick is unavailable at boot.</p>
<div class=code>#!/ffp/bin/sh
PATH=/ffp/sbin:/ffp/bin:/usr/sbin:/sbin:/usr/bin:/bin
# Use ffp busybox instead
mv /bin/busybox /bin/busybox-dns323
ln -s /ffp/bin/busybox /bin/busybox
if [ ! -h /data ]; then
ln -s /mnt/HD_a2 /data
fi
# if we're running from USB, then make sure home is mounted
if [ -d /mnt/usb/home/root ]; then
chmod -x /ffp/start/authorize*.sh 2>/dev/null
grep /home /proc/mounts >/dev/null 2>/dev/null
if [ $? -ne 0 ]; then
mount --bind /mnt/usb/home /home
fi
else
# If we aren't running from USB, make sure authorize* scripts are executable
chmod -x /ffp/start/authorize*.sh 2>/dev/null
fi
# update home directories in /etc/passwd (DNS-323 likes to reset them..)
usermod -d /home/xx -g 510 xx
# set timezone
echo 'EST5EDT,M3.2.0,M11.1.0' > /etc/TZ
# change cron jobs
echo "** Update cron jobs"
# This removes firmware cronjobs that interfere with ntpd.
crontab -l | grep -vw '/usr/sbin/daylight' | grep -vw '/usr/sbin/rtc' | grep -vw '/usr/sbin/stime' | crontab -
# Now start custom cron jobs, including the first which checks the date.
echo "0 * * * * /ffp/hostname/checkdate.sh" >> /var/spool/cron/crontabs/root
echo "1 * * * * /ffp/hostname/routerset.pl" >> /var/spool/cron/crontabs/root
echo "2 3 * * * /ffp/hostname/ffp-sync.sh" >> /var/spool/cron/crontabs/root
echo "5 3 * * * /ffp/hostname/backup.sh" >> /var/spool/cron/crontabs/root
cat /var/spool/cron/crontabs/root
# force a cronjob update
echo "root" >> /var/spool/cron/crontabs/cron.update
</div>
<p>References:
<ul>
<li><a href=http://forum.dsmg600.info/t2125-DNS-323-Rsync-Time-Machine!.html>Rsync Time Machine (DNS-323 forum)</a> -- source of backup script</li>
<li><a href=http://blog.interlinked.org/tutorials/rsync_time_machine.html>Time Machine for every Unix out there</a></li>
<li><a href="http://forum.dsmg600.info/viewtopic.php?id=1150">Tutorial: Backup Everything from Vol A to Vol B once a night</a></li>
</ul></p>
</section>
<footer class=byline>
<div>posted <time class=post_date>21 August 2010</time></div>
<div class=tags>tags:
<ul><li>&nbsp;<a href=/tags/#backup>backup</a></li><li>&nbsp;<a href=/tags/#hardware-nas>hardware-nas</a></li></ul>
</div>
</footer>
</article>
<nav class=prev-next>
<div class=nav-left><a href=/2010/05/16/dns-323-finally-back-to-it-sshbusybox.html title="Previous: DNS-323: Finally back to it (SSH/busybox)">&#171; Older</a></div>
<div class=nav-center><a href=/>Top</a> | <a href=/archive/>Archive</a></div>
<div class=nav-right><a href=/2010/10/26/ubuntu-1010-sound-crackling-especially-pidgin-and-fluxbox-crashes.html title="Next: ubuntu 10.10: sound crackling (especially pidgin), and fluxbox crashes">Newer &#187;</a></div>
</nav>
</main>
</div>
<footer class=page-footer>
<div id=copyrights>&#169; 2002-2023 Erin Schnabel</div>
<div class=icons>
<a target=_blank rel=nopopener href=https://github.com/ebullient title="ebullient on GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</a>
<a target=_blank rel="me nopopener" href=https://fosstodon.org/@ebullient title="Follow @ebullient"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</a>
<a target=_blank rel=nopopener href=https://www.linkedin.com/in/erinschnabel/ title="Erin Schnabel on linked.in"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1.0 83.5.0 53.8a53.79 53.79.0 01107.58.0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29.0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
</a>
<a target=_blank rel=nopopener href=/index.xml title=Subscribe><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg> </a>
</div>
</footer>
</body>
</html>